<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Life OS</title>

  <!-- ✅ Supabase v2 (global = window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0b0f;
      --card:#151522;
      --muted:#a7a7c7;
      --text:#f2f2ff;
      --accent:#6c5ce7;
      --border:rgba(255,255,255,.08);
      --soft:rgba(255,255,255,.06);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;
      --pad:14px;
      --max:820px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(108,92,231,.18), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(255,255,255,.07), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,11,15,.78);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:14px;}
    h1{margin:0; font-size:18px; letter-spacing:.2px;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted); font-size:12px;
    }

    main{padding:14px; padding-bottom:88px;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 760px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      text-transform: uppercase;
    }

    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      color:var(--text);
      border-radius: 12px;
      padding: 12px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(242,242,255,.45)}
    textarea{min-height:120px; resize:vertical}

    .btn{
      appearance:none;
      border:0;
      border-radius: 12px;
      padding: 12px 14px;
      background: var(--accent);
      color:white;
      font-weight:700;
      cursor:pointer;
      width:100%;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color: var(--text);
      border:1px solid var(--border);
      font-weight:600;
    }
    .btn.small{width:auto; padding:8px 10px; border-radius:999px; font-weight:600; font-size:12px}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .checkrow{
      display:flex; align-items:center; gap:10px;
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .checkrow input[type="checkbox"]{width:18px; height:18px; margin:0}
    .checkrow .meta{margin-left:auto; color:var(--muted); font-size:12px}

    nav{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background: rgba(11,11,15,.88);
      border-top:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .tabs{
      max-width:var(--max);
      margin:0 auto;
      display:flex;
      gap:8px;
      padding:10px 14px;
      justify-content:space-between;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:10px 8px;
      border-radius: 14px;
      color: var(--muted);
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      background: transparent;
    }
    .tab.active{
      background: rgba(108,92,231,.18);
      border-color: rgba(108,92,231,.35);
      color: var(--text);
    }

    /* Auth overlay */
    .overlay{
      position:fixed; inset:0; z-index:50;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      padding:16px;
    }
    .overlay.show{display:flex}
    .authbox{
      width:min(520px, 100%);
      background: rgba(21,21,34,.98);
      border:1px solid var(--border);
      border-radius: 18px;
      padding:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    .authbox h3{margin:0 0 8px 0}
    .authbox p{margin:0 0 12px 0; color:var(--muted); font-size:13px}
    .authrow{display:grid; grid-template-columns: 1fr; gap:10px}
    .tiny{font-size:12px; color:var(--muted); margin-top:10px}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:86px;
      background: rgba(21,21,34,.96);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      display:none;
      z-index:60;
      max-width:90vw;
      box-shadow: var(--shadow);
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div>
          <h1>Life OS</h1>
          <div class="sub" id="subline">Today</div>
        </div>
        <div class="spacer"></div>
        <div class="pill" id="userPill">Not signed in</div>
        <button class="btn small secondary" id="btnSignOut" style="display:none;">Sign out</button>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- TODAY -->
    <section id="screen-today">
      <div class="card" style="margin-bottom:12px;">
        <h2>What matters today (max 10 words)</h2>
        <input id="focusLine" placeholder="Example: Salah + water + 10 min course" maxlength="80" />
        <div class="tiny">Tip: keep it short so you don’t overthink.</div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>IBADAH (Fard first)</h2>
          <label class="checkrow">
            <input type="checkbox" data-check="salah">
            <div>5 Salah</div>
            <div class="meta">must</div>
          </label>
          <label class="checkrow">
            <input type="checkbox" data-check="tasbeeh">
            <div>Tasbeehat</div>
            <div class="meta">daily</div>
          </label>
          <label class="checkrow">
            <input type="checkbox" data-check="quran">
            <div>Quran (min)</div>
            <div class="meta">min 1 page</div>
          </label>

          <div style="height:8px"></div>

          <label class="checkrow">
            <input type="checkbox" data-check="tahajjud">
            <div>Tahajjud</div>
            <div class="meta">bonus</div>
          </label>
          <label class="checkrow">
            <input type="checkbox" data-check="ishraq">
            <div>Ishraq</div>
            <div class="meta">bonus</div>
          </label>
        </div>

        <div class="card">
          <h2>BODY</h2>

          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1">
              <div class="pill" style="width:100%; justify-content:space-between;">
                <span>Water (L)</span>
                <span id="waterVal">0</span>
              </div>
            </div>
            <button class="btn small secondary" id="waterMinus">-</button>
            <button class="btn small secondary" id="waterPlus">+</button>
          </div>

          <div style="margin-bottom:10px;">
            <div class="sub" style="margin-bottom:6px;">Steps</div>
            <input id="steps" type="number" min="0" placeholder="15000" />
          </div>

          <div style="margin-bottom:10px;">
            <div class="sub" style="margin-bottom:6px;">Sleep (hours)</div>
            <input id="sleep" type="number" min="0" step="0.5" placeholder="8" />
          </div>

          <div>
            <div class="sub" style="margin-bottom:6px;">Movement</div>
            <select id="movement">
              <option value="">Not yet</option>
              <option value="walk">Walk</option>
              <option value="gym">Gym</option>
              <option value="stretch">Stretch</option>
              <option value="sports">Sports</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- GOALS -->
    <section id="screen-goals" style="display:none;">
      <div class="card">
        <h2>Goals</h2>
        <textarea id="goalsText" placeholder="Write 1–3 goals. Keep them simple."></textarea>
        <div style="height:10px"></div>
        <button class="btn secondary" id="saveGoals">Save</button>
      </div>
    </section>

    <!-- JOURNAL -->
    <section id="screen-journal" style="display:none;">
      <div class="card">
        <h2>Journal</h2>
        <textarea id="journalText" placeholder="Quick thoughts. What worked / what didn’t?"></textarea>
        <div style="height:10px"></div>
        <button class="btn secondary" id="saveJournal">Save</button>
      </div>
    </section>

    <!-- REMINDERS -->
    <section id="screen-reminders" style="display:none;">
      <div class="card">
        <h2>Reminders</h2>
        <div class="row" style="gap:10px;">
          <button class="btn secondary" id="btnLowEnergy">Low-energy mode</button>
          <button class="btn secondary" id="btnEnableNotifs">Enable reminders</button>
        </div>
        <div class="tiny" id="notifHint" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- WEEKLY -->
    <section id="screen-weekly" style="display:none;">
      <div class="card">
        <h2>Weekly</h2>
        <textarea id="weeklyText" placeholder="What worked? What didn’t? What to fix next week?"></textarea>
        <div style="height:10px"></div>
        <button class="btn secondary" id="saveWeekly">Save</button>
      </div>
    </section>

  </main>

  <!-- Bottom tabs -->
  <nav>
    <div class="tabs">
      <div class="tab active" data-tab="today">Today</div>
      <div class="tab" data-tab="goals">Goals</div>
      <div class="tab" data-tab="journal">Journal</div>
      <div class="tab" data-tab="reminders">Reminders</div>
      <div class="tab" data-tab="weekly">Weekly</div>
    </div>
  </nav>

  <!-- Auth overlay -->
  <div class="overlay" id="authOverlay">
    <div class="authbox">
      <h3>Sign in</h3>
      <p>Use Google or email link. (One-time sign-in.)</p>

      <div class="authrow">
        <button class="btn" id="btnGoogle">Continue with Google</button>

        <input id="emailInput" type="email" placeholder="Enter email" />
        <button class="btn secondary" id="btnEmail">Continue with Email</button>
      </div>

      <div class="tiny" id="authMsg"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /********************
     * CONFIG
     ********************/
    // ✅ Put your real Supabase project details here
    const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY";

    // Local storage keys
    const LS_KEY = "life_os_v2";
    const todayKey = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD

    // ✅ Create ONLY ONE client (global variable "sb")
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /********************
     * UI helpers
     ********************/
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display="none", 2200);
    }

    function setSubline(){
      const d = new Date();
      const opts = { weekday:"long", month:"short", day:"numeric" };
      $("subline").textContent = d.toLocaleDateString(undefined, opts);
    }

    /********************
     * Local state
     ********************/
    function defaults(){
      return {
        meta: {
          createdAt: Date.now(),
          lastOpen: Date.now(),
          lowEnergy: false
        },
        day: {},        // day[YYYY-MM-DD] = { checks:{}, water, steps, sleep, movement, focusLine }
        goals: "",
        journal: {},    // journal[YYYY-MM-DD] = "..."
        weekly: ""      // simple placeholder
      };
    }

    function load(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEY)) || defaults();
      }catch(e){
        return defaults();
      }
    }
    let state = load();

    function save(){
      state.meta.lastOpen = Date.now();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function ensureDay(){
      const k = todayKey();
      if(!state.day[k]){
        state.day[k] = {
          checks: {},
          water: 0,
          steps: "",
          sleep: "",
          movement: "",
          focusLine: ""
        };
      }
      return state.day[k];
    }

    /********************
     * Tabs
     ********************/
    const screens = ["today","goals","journal","reminders","weekly"];
    function showTab(name){
      screens.forEach(s=>{
        const sec = $("screen-" + s);
        sec.style.display = (s === name) ? "block" : "none";
      });
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab === name);
      });
    }
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=> showTab(t.dataset.tab));
    });

    /********************
     * Render + bind
     ********************/
    function renderToday(){
      const d = ensureDay();

      $("focusLine").value = d.focusLine || "";
      $("waterVal").textContent = String(d.water || 0);
      $("steps").value = d.steps ?? "";
      $("sleep").value = d.sleep ?? "";
      $("movement").value = d.movement ?? "";

      document.querySelectorAll('input[type="checkbox"][data-check]').forEach(cb=>{
        const key = cb.getAttribute("data-check");
        cb.checked = !!(d.checks && d.checks[key]);
      });

      // low energy mode UI
      $("btnLowEnergy").textContent = state.meta.lowEnergy ? "Low-energy: ON" : "Low-energy: OFF";
    }

    function renderTextAreas(){
      $("goalsText").value = state.goals || "";
      $("journalText").value = state.journal[todayKey()] || "";
      $("weeklyText").value = state.weekly || "";
    }

    function bindInputs(){
      $("focusLine").addEventListener("input", (e)=>{
        ensureDay().focusLine = e.target.value.trim();
        save();
      });

      document.querySelectorAll('input[type="checkbox"][data-check]').forEach(cb=>{
        cb.addEventListener("change", ()=>{
          const d = ensureDay();
          const key = cb.getAttribute("data-check");
          d.checks[key] = cb.checked;
          save();
        });
      });

      $("waterPlus").addEventListener("click", ()=>{
        const d = ensureDay();
        d.water = Math.min(20, (d.water || 0) + 1);
        $("waterVal").textContent = String(d.water);
        save();
      });
      $("waterMinus").addEventListener("click", ()=>{
        const d = ensureDay();
        d.water = Math.max(0, (d.water || 0) - 1);
        $("waterVal").textContent = String(d.water);
        save();
      });

      $("steps").addEventListener("input", (e)=>{
        ensureDay().steps = e.target.value;
        save();
      });
      $("sleep").addEventListener("input", (e)=>{
        ensureDay().sleep = e.target.value;
        save();
      });
      $("movement").addEventListener("change", (e)=>{
        ensureDay().movement = e.target.value;
        save();
      });

      $("saveGoals").addEventListener("click", ()=>{
        state.goals = $("goalsText").value.trim();
        save();
        toast("Goals saved");
      });
      $("saveJournal").addEventListener("click", ()=>{
        state.journal[todayKey()] = $("journalText").value.trim();
        save();
        toast("Journal saved");
      });
      $("saveWeekly").addEventListener("click", ()=>{
        state.weekly = $("weeklyText").value.trim();
        save();
        toast("Weekly saved");
      });

      $("btnLowEnergy").addEventListener("click", ()=>{
        state.meta.lowEnergy = !state.meta.lowEnergy;
        save();
        renderToday();
        toast(state.meta.lowEnergy ? "Low-energy ON" : "Low-energy OFF");
      });

      $("btnEnableNotifs").addEventListener("click", async ()=>{
        if(!("Notification" in window)){
          $("notifHint").textContent = "Notifications not supported in this browser.";
          return;
        }
        const perm = await Notification.requestPermission();
        $("notifHint").textContent = (perm === "granted")
          ? "Notifications enabled ✅"
          : "Notifications blocked. You can enable it from browser settings.";
      });
    }

    /********************
     * AUTH
     ********************/
    function showAuth(show){
      $("authOverlay").classList.toggle("show", !!show);
    }

    async function refreshAuthUI(){
      const { data } = await sb.auth.getSession();
      const session = data?.session;

      if(session?.user){
        const email = session.user.email || "Signed in";
        $("userPill").textContent = email;
        $("btnSignOut").style.display = "inline-flex";
        showAuth(false);
      } else {
        $("userPill").textContent = "Not signed in";
        $("btnSignOut").style.display = "none";
        showAuth(true);
      }
    }

    $("btnGoogle").addEventListener("click", async ()=>{
      try{
        $("authMsg").textContent = "";
        // redirectTo must be allowed in Supabase Auth settings
        const redirectTo = window.location.origin;
        const { error } = await sb.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo }
        });
        if(error) throw error;
      }catch(e){
        $("authMsg").textContent = "Google sign-in error: " + (e.message || e);
      }
    });

    $("btnEmail").addEventListener("click", async ()=>{
      try{
        $("authMsg").textContent = "";
        const email = $("emailInput").value.trim();
        if(!email) { $("authMsg").textContent = "Enter an email first."; return; }

        // emailRedirectTo must be allowed too
        const emailRedirectTo = window.location.origin;

        const { error } = await sb.auth.signInWithOtp({
          email,
          options: { emailRedirectTo }
        });

        if(error) throw error;
        $("authMsg").textContent = "Check your email for the login link ✅";
        toast("Login link sent");
      }catch(e){
        $("authMsg").textContent = "Email sign-in error: " + (e.message || e);
      }
    });

    $("btnSignOut").addEventListener("click", async ()=>{
      await sb.auth.signOut();
      toast("Signed out");
      await refreshAuthUI();
    });

    // Keep UI synced with auth state
    sb.auth.onAuthStateChange((_event, _session) => {
      refreshAuthUI();
    });

    /********************
     * INIT
     ********************/
    (function init(){
      setSubline();
      ensureDay();
      save();
      renderToday();
      renderTextAreas();
      bindInputs();
      showTab("today");

      // start auth flow
      refreshAuthUI();
    })();
  </script>
</body>
</html>


